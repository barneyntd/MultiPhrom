1000 DIM BUFF% 260:DIM CTRL% 18:X%=CTRL% AND &FF:Y%=CTRL% DIV &1001010 PROCCODE(BUFF%)1020 CLOSE#0:REPEAT1030 PRINT "Enter Phrom slot number (C0-FF)";:INPUT PHFN$1040 PHFN = EVAL("&"+PHFN$)1050 UNTIL PHFN >= &C0 AND PHFN <= &FF1060 IF PHFN < &F0 THEN PRINT "Warning: OS 1.2 only reads files from slots F0 - FF"1080 PRINT "Enter copyright string (optional)";:INPUT CPYRT$1090 IF LEFT$(CPYRT$,3) <> "(C)" THEN CPYRT$ = "(C) " + CPYRT$1100 PROCOPEN1110 REPEAT1120 PRINT "Slot " STR$~PHFN ", " &3FFF-EXT#(PHFILE) " bytes free."1130 PRINT "Enter filename to save in Phrom, or *command, or #title,":PRINT "or RETURN to finish";1140 INPUT SFN$1150 IF SFN$ = "" THEN UNTIL TRUE:PROCCLOSE:END1160 IF LEFT$(SFN$,1) = "*" THEN OSCLI MID$(SFN$,2):UNTIL FALSE1170 IF LEFT$(SFN$,1)="#"THEN PROCTITLE(MID$(SFN$,2)):UNTIL FALSE1180 !CTRL%=BUFF%:$BUFF%=SFN$1190 A%=5:R%=USR(&FFDD)1200 IF (R% AND &FF) <> 1 THEN PRINT "File not found.":UNTIL FALSE1210 L%=CTRL%!10:BLKS%=(L%-1) DIV &100 +11220 LA%=CTRL%!2:EA%=CTRL%!6:AT%=CTRL%?141230 SSFN$=SFN$:REPEAT:SSFN$=MID$(SSFN$,INSTR(SSFN$,".")+1):UNTIL INSTR(SSFN$,".")=01235 IF SSFN$="" THEN SSFN$="_"1240 SSFN$=LEFT$(SSFN$,10):N%=LEN(SSFN$)1250 NXT%=FNNXT(0)1260 SFILE=OPENIN(SFN$)1270 FOR I%=1 TO BLKS%1280 FLAG% = (PTR#PHFILE = NXT%):IF FLAG% THEN PROCCLOSE:PHFN=(PHFN+1)AND&FF:PROCOPEN:NXT%=FNNXT(I%-1)1290 IF FLAG% OR I%=1 OR I%=BLKS% THEN PROCHEADER(I%=BLKS%,EOF#(SFILE),I%-1) ELSE BPUT#PHFILE,&231300 ?CTRL%=SFILE:CTRL%!1=BUFF%:CTRL%!5=2561310 A%=4:R%=USR(&FFD1)1320 BL%=CTRL%!1-BUFF%:!(CTRL%!1)=FNCRC(BL%)1330 ?CTRL%=PHFILE:CTRL%!1=BUFF%:CTRL%!5=BL%+21340 A%=2:R%=USR(&FFD1)1350 NEXT1360 CLOSE#SFILE1370 UNTIL FALSE1380 END1430 DEF FNNXT(DONE%)1440 LOCAL BASE%,FULL%1450 BASE%=PTR#PHFILE+N%+201460 IF BASE% > &3FFE THEN = PTR#PHFILE1470 FULL%=BASE%+L%+BLKS%*3-DONE%*259:IF BLKS%-DONE% > 1 THEN FULL%=FULL%+N%+201480 IF FULL% <= &3FFE THEN = FULL% ELSE = BASE%+((&3FFE - BASE%) DIV 259) * 2591490 DEF PROCCLOSE1500 BPUT#PHFILE,&2B1510 PTR#PHFILE=60:BPUT#PHFILE,FNREVBYTE(EXT#PHFILE AND &FF):BPUT#PHFILE,FNREVBYTE(EXT#PHFILE DIV &100)1520 CLOSE#(PHFILE)1530 ENDPROC1540 DEF PROCOPEN1550 LOCAL I%1570 PHFILE$="Ph_"+STR$~(PHFN)+"N":PHFILE = OPENOUT(PHFILE$)1580 BPUT#PHFILE,0:BPUT#PHFILE,01590 TITLE$=CPYRT$+CHR$(0)+PHFILE$+CHR$(0)+STRING$(46," "):FOR I%=1TO51:BPUT#PHFILE,ASC(MID$(TITLE$,I%,1)):NEXT1600 FOR I%=1TO7:BPUT#PHFILE,0:NEXT1610 BPUT#PHFILE,&FF:BPUT#PHFILE,&FF:BPUT#PHFILE,2:BPUT#PHFILE,01620 ENDPROC2170 DEF PROCHEADER(LAST%,EMPTY%,BN%)2180 LOCAL I%2190 $BUFF%=SSFN$2200 BUFF%?N%=0:BUFF%!(N%+1)=LA%:BUFF%!(N%+5)=EA%:BUFF%!(N%+9)=BN%2210 IF LAST% THEN BUFF%!(N%+11)=L% - PTR#SFILE:BUFF%?(N%+13)=&80 ELSE BUFF%!(N%+11)=256:BUFF%?(N%+13)=02220 IF EMPTY% THEN BUFF%?(N%+13)=BUFF%?(N%+13) OR &402230 IF AT% AND 4 THEN BUFF%?(N%+13)=BUFF%?(N%+13) OR 12240 IF PHFN >= &80 THEN BUFF%!(N%+14)=NXT% ELSE BUFF%!(N%+14)=NXT%+&80002250 BUFF%!(N%+18)=FNCRC(N%+18)2260 BPUT#PHFILE,&2A:FOR I%=0 TO N%+19:BPUT#PHFILE,BUFF%?I%:NEXT2270 ENDPROC2280 DEF PROCTITLE(N$)2290 SSFN$=LEFT$(N$,10):N%=LEN(SSFN$)2300 LA%=0:EA%=0:AT%=0:L%=02310 IF PTR#PHFILE >= &3FFE-N%-20 THEN PROCCLOSE:PHFN=(PHFN+1)AND&FF:PROCOPEN2320 NXT%=PTR#PHFILE+N%+212330 PROCHEADER(TRUE,TRUE,0)2340 ENDPROC2350 DEF FNCRC (A%)2360 R%=USR(CRC)2370 =!&812380 DEF FNREVBYTE (A%)2390 R%=USR(REVERSE)2400 =R% AND &FF2410 DEF PROCCODE(BUFF%)2420 DIM MC% 1002430 FOR I=0 TO 2 STEP 22440 P% = MC%2450 [OPTI2460 .REVERSE STA &802470 ROL &802480 ROR A2490 ROL &802500 ROR A2510 ROL &802520 ROR A2530 ROL &802540 ROR A2550 ROL &802560 ROR A2570 ROL &802580 ROR A2590 ROL &802600 ROR A2610 ROL &802620 ROR A2630 RTS2640 .CRC STA &802650 LDA #02660 STA &822670 STA &812680 TAY2690 .NBYT LDA &812700 EOR BUFF%,Y2710 STA &812720 LDX #82730 .LOOP LDA &812740 ROL A2750 BCC B7Z2760 LDA &812770 EOR #82780 STA &812790 LDA &822800 EOR #&102810 STA &822820 .B7Z ROL &822830 ROL &812840 DEX2850 BNE LOOP2860 INY2870 CPY &802880 BNE NBYT2890 RTS2900 ]2910 NEXT2920 ENDPROC